AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: AWS REST API with CORS

Outputs:

  StackRegion:
    Value: !Ref AWS::Region
  ItemTableName:
    Value: !Ref ItemTable
  ItemsFnCreateArn:
    Value: !GetAtt ItemsFnCreate.Arn
  ItemsFnIndexArn:
    Value: !GetAtt ItemsFnIndex.Arn

Resources:

  ############
  ## TABLES ##
  ############

  ItemTable:
    Type: AWS::Serverless::SimpleTable
    Properties:
      PrimaryKey:
        Name: Name
        Type: String

  ###############
  ## Functions ##
  ###############

  ItemsFnCreate:
    Type: AWS::Serverless::Function
    Properties:
      Handler: handlers/items.create
      Runtime: nodejs6.10
      CodeUri: ./package/aws-cors-api.zip
      Policies: AmazonDynamoDBFullAccess
      Environment:
        Variables:
          ITEM_TABLE: !Ref ItemTable

  ItemsFnIndex:
    Type: AWS::Serverless::Function
    Properties:
      Handler: handlers/items.index
      Runtime: nodejs6.10
      CodeUri: ./package/aws-cors-api.zip
      Policies: AmazonDynamoDBFullAccess
      Environment:
        Variables:
          ITEM_TABLE: !Ref ItemTable

  #########
  ## API ##
  #########

  ItemsApi:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: Items API

  ItemsCollection:
    Type: AWS::ApiGateway::Resource
    Properties:
      PathPart: items
      RestApiId: !Ref ItemsApi
      ParentId: !GetAtt ItemsApi.RootResourceId

  ItemsCollectionOptions:
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: NONE
      HttpMethod: OPTIONS
      RestApiId: !Ref ItemsApi
      ResourceId: !Ref ItemsCollection
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key'"
              method.response.header.Access-Control-Allow-Methods: "'*'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
      MethodResponses:
        - StatusCode: 200
          ResponseModels:
            application/json: Empty
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false

  ItemsCollectionPost:
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: NONE
      HttpMethod: POST
      RestApiId: !Ref ItemsApi
      ResourceId: !Ref ItemsCollection
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ItemsFnCreate.Arn}/invocations

  ItemsCollectionGet:
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: NONE
      HttpMethod: GET
      RestApiId: !Ref ItemsApi
      ResourceId: !Ref ItemsCollection
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ItemsFnIndex.Arn}/invocations

  #################
  ## Permissions ##
  #################

  ItemsCollectionPostInvokeItemsFnCreate:
    Type: AWS::Lambda::Permission
    Properties:
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ItemsApi}/*/POST/items
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt ItemsFnCreate.Arn

  ItemsCollectionGetInvokeItemsFnIndex:
    Type: AWS::Lambda::Permission
    Properties:
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ItemsApi}/*/GET/items
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt ItemsFnIndex.Arn
