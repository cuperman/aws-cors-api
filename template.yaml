AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: AWS REST API with CORS

Outputs:

  StackRegion:
    Value: !Ref AWS::Region
  ItemTableName:
    Value: !Ref ItemTable
  ItemsFnCreateArn:
    Value: !GetAtt ItemsFnCreate.Arn
  ItemsFnIndexArn:
    Value: !GetAtt ItemsFnIndex.Arn

Resources:

  ############
  ## TABLES ##
  ############

  ItemTable:
    Type: AWS::Serverless::SimpleTable
    Properties:
      PrimaryKey:
        Name: Name
        Type: String

  ###############
  ## Functions ##
  ###############

  ItemsFnCreate:
    Type: AWS::Serverless::Function
    Properties:
      Handler: handlers/items.create
      Runtime: nodejs6.10
      CodeUri: ./package/aws-cors-api.zip
      Policies: AmazonDynamoDBFullAccess
      Environment:
        Variables:
          ITEM_TABLE: !Ref ItemTable

  ItemsFnIndex:
    Type: AWS::Serverless::Function
    Properties:
      Handler: handlers/items.index
      Runtime: nodejs6.10
      CodeUri: ./package/aws-cors-api.zip
      Policies: AmazonDynamoDBFullAccess
      Environment:
        Variables:
          ITEM_TABLE: !Ref ItemTable

  #########
  ## API ##
  #########

  ItemsApi:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: Items API

  ItemsCollection:
    Type: AWS::ApiGateway::Resource
    Properties:
      PathPart: items
      RestApiId: !Ref ItemsApi
      ParentId: !GetAtt ItemsApi.RootResourceId

  ItemsCollectionPost:
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: NONE
      HttpMethod: POST
      RestApiId: !Ref ItemsApi
      ResourceId: !Ref ItemsCollection
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Join
          - ''
          - - 'arn:aws:apigateway:'
            - !Ref AWS::Region
            - ':lambda:path/2015-03-31/functions/arn:aws:lambda:'
            - !Ref AWS::Region
            - ':'
            - !Ref AWS::AccountId
            - ':function:'
            - !Ref ItemsFnCreate
            - '/invocations'

  ItemsCollectionGet:
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: NONE
      HttpMethod: GET
      RestApiId: !Ref ItemsApi
      ResourceId: !Ref ItemsCollection
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: GET
        Uri: !Join
          - ''
          - - 'arn:aws:apigateway:'
            - !Ref AWS::Region
            - ':lambda:path/2015-03-31/functions/arn:aws:lambda:'
            - !Ref AWS::Region
            - ':'
            - !Ref AWS::AccountId
            - ':function:'
            - !Ref ItemsFnIndex
            - '/invocations'
